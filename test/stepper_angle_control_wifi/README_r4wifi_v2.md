# ステッピングモーター角度制御システム v2（Arduino R4 Wi-Fi対応版）

このプログラムは28BYJ-48ステッピングモーターを制御するための強化版システムです。Arduino R4 Wi-Fiの内蔵無線通信機能を利用して、Telnetクライアントに加えて、Webブラウザからの操作にも対応しました。

## 新機能

- **ウェブインターフェース**: ブラウザからの直感的な操作が可能
- **複数の動作モード**: 角度制御、連続回転、パターン回転に対応
- **OTAアップデート**: Wi-Fi経由でスケッチを更新可能
- **プリセット位置保存**: よく使う角度を名前付きで保存
- **セキュリティ機能**: 管理者機能に簡易認証を追加
- **ステータスLED**: 動作モードに応じたLEDパターン表示

## 機能

- **Wi-Fi接続**: 内蔵Wi-Fi機能によるワイヤレス制御
- **Webサーバー**: ブラウザからの操作が可能
- **Telnetサーバー**: コマンドライン操作も継続サポート
- **OTAアップデート**: Wi-Fi経由でスケッチを更新可能
- **絶対角度制御**: 指定した角度（0〜360度）へモーターを回転
- **相対角度制御**: 現在位置から指定した角度だけモーターを回転
- **連続回転モード**: 時計回り/反時計回りの連続回転
- **パターン回転モード**: 事前設定されたパターンで自動回転
- **最短経路計算**: 目標角度まで最短のルートで回転
- **電源節約モード**: 停止時に自動的にモーターの電源をオフ
- **速度プリセット**: 5段階の速度設定からトルクと速度のバランスを選択
- **現在位置リセット**: 現在位置を0度として再設定
- **プリセット位置**: 10個までの角度位置をEEPROMに保存
- **セキュリティ機能**: 管理者機能に簡易的なパスワード保護

## ハードウェア接続

### モーター接続
- MOTOR_PIN1: 8番ピン
- MOTOR_PIN2: 9番ピン
- MOTOR_PIN3: 10番ピン
- MOTOR_PIN4: 11番ピン

## セットアップ手順

1. **Wi-Fi設定の変更**:
   - スケッチファイル内の以下の部分を変更します:
   ```cpp
   const char* ssid = "YOUR_WIFI_SSID";      // ご使用のWi-FiのSSID
   const char* password = "YOUR_WIFI_PASSWORD";  // Wi-Fiのパスワード
   const char* adminPassword = "admin123";    // 管理者パスワード（変更推奨）
   ```

2. **スケッチのアップロード**:
   - Arduino IDEを使ってスケッチをArduino R4 Wi-Fiにアップロードします
   - アップロード後、シリアルモニタでIPアドレスを確認します

3. **接続方法**:
   - **ブラウザ**: 表示されたIPアドレスをブラウザで開きます（例: http://192.168.1.100）
   - **Telnet**: パソコンからTelnetクライアントを使用して、表示されたIPアドレスのポート23に接続します

## 使用方法

### Webインターフェース

ブラウザでArduinoのIPアドレスにアクセスすると、以下の機能を持つWebインターフェースが表示されます：

1. **制御パネル**:
   - 角度スライダー: 目標角度を設定して移動ボタンをクリック
   - 相対移動: 相対角度を入力して移動、または+/-90°ボタンをクリック
   - 動作モード: 4つの動作モードを切り替え

2. **プリセット**:
   - プリセット保存: 現在位置に名前を付けて保存
   - プリセット一覧: 保存済みプリセットの表示と呼び出し

3. **設定**:
   - 速度設定: 5段階の速度プリセットを選択
   - 電源設定: 電源節約モードの切り替え

### Telnetコマンド

Wi-Fi経由でTelnet接続したら、以下のコマンドを送信してモーターを制御できます：

#### 角度制御
- `a[角度]`: 絶対角度を指定（例: `a90` で90度の位置へ移動）
- `r[角度]`: 相対角度を指定（例: `r45` で現在位置から45度移動）
- `z`: 現在位置を0度にリセット

#### モード設定
- `m0`: 角度制御モード
- `m1`: 連続時計回り回転
- `m2`: 連続反時計回り回転
- `m3`: パターン回転モード

#### プリセット
- `ps[番号] [名前]`: プリセットを保存（例: `ps1 ホームポジション`）
- `pl[番号]`: プリセットを読み込み（例: `pl1`）
- `pd`: プリセット一覧表示

#### システム設定
- `s`: 現在の状態を表示
- `p`: 電源節約モードの切り替え
- `v[1-5]`: 速度プリセットを選択（1:遅い, 3:通常, 5:高速）
- `h`: ヘルプメッセージを表示
- `login [パスワード]`: 管理者として認証
- `reboot`: システムを再起動（要管理者認証）

## 動作モード

1. **角度制御モード**:
   - 指定した角度に移動して停止
   - 電源節約モードが有効な場合、目標位置に到達後は電源オフ

2. **連続時計回り回転**:
   - モーターが一定速度で時計回りに連続回転
   - 停止するまで回転し続ける

3. **連続反時計回り回転**:
   - モーターが一定速度で反時計回りに連続回転
   - 停止するまで回転し続ける

4. **パターン回転モード**:
   - あらかじめ設定されたパターンで自動的に回転
   - 5秒ごとに異なるパターンに切り替わる

## 速度プリセット

1. **非常に遅い**: 高トルク、高精度（400 steps/sec）
2. **遅い**: バランス型（700 steps/sec）
3. **通常**: バランス型（1000 steps/sec）
4. **速い**: 高速、中トルク（1300 steps/sec）
5. **非常に速い**: 最高速度、低トルク（1600 steps/sec）

## OTAアップデート

Arduino IDEを使用してWi-Fi経由でスケッチをアップデートできます：

1. Arduino IDEのポートメニューで、ネットワークデバイスとして表示されるArduino R4 Wi-Fiを選択
2. 「StepperController」という名前で表示されます
3. アップロード時にパスワードを要求された場合は、スケッチで設定した管理者パスワードを入力

## トラブルシューティング

1. **Wi-Fi接続ができない場合**:
   - SSIDとパスワードが正しいか確認
   - Arduino R4 Wi-FiがWi-Fiルーターの範囲内にあるか確認
   - Wi-Fiネットワークが2.4GHz帯域を使用しているか確認

2. **Webインターフェースにアクセスできない場合**:
   - 正しいIPアドレスにアクセスしているか確認
   - 他のデバイスからArduinoのIPアドレスにpingを送信して接続を確認
   - ファイアウォールやセキュリティソフトがポート80をブロックしていないか確認

3. **OTAアップデートができない場合**:
   - Arduino IDEが最新バージョンであることを確認
   - WiFiS3およびArduinoOTAライブラリが正しくインストールされているか確認
   - Arduino R4 Wi-FiとPCが同じネットワーク上にあることを確認

4. **モーターが正しく動作しない場合**:
   - ピン接続が正しいか確認
   - 電源電圧が安定しているか確認（USBバスパワーだけでは不安定な場合があります）
   - 高速モードでトルク不足がある場合は、速度プリセットを下げてみる

## 注意事項

- 高速での動作時はトルクが低下します
- 長時間の連続動作は避けてください（モーターが過熱する可能性があります）
- 電源節約モードを無効にすると、停止時もコイルに電流が流れ続けます
- Wi-Fi接続は電力を消費するため、バッテリー駆動の場合は動作時間に影響します
- セキュリティのため、重要な用途では公開ネットワークでの使用を避けてください
- 管理者パスワードは必ず変更してください

## 使用ライブラリ

- AccelStepper: ステッピングモーターの制御
- WiFiS3: Arduino R4 Wi-Fi用のWi-Fi機能
- ArduinoOTA: Wi-Fi経由のソフトウェアアップデート
- EEPROM: プリセット位置の保存

## 今後の拡張可能性

1. **スマートフォンアプリ連携**: 専用のスマートフォンアプリを作成して連携
2. **複数モーター制御**: 複数のステッピングモーターを同時に制御
3. **センサー連携**: エンコーダーやセンサーを追加して位置フィードバック
4. **高度なパターン設定**: ユーザー定義のパターンをWebインターフェースから設定
5. **リモートログ機能**: 動作ログをリモートサーバーに送信
6. **MQTTプロトコル対応**: IoTシステムとの連携